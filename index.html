<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Task Manager - Enhanced Version</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        .container {
            max-width: 1200px;
            padding: 20px;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            background: white;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: scale(1.02);
        }
        .navbar {
            background: linear-gradient(90deg, #4a90e2, #50e3c2);
            border-radius: 10px;
        }
        .navbar .nav-link {
            color: white !important;
            margin: 0 10px;
        }
        .navbar .nav-link:hover {
            color: #ffd700 !important;
        }
        .btn-success {
            background-color: #4a90e2;
            border: none;
        }
        .btn-success:hover {
            background-color: #357abd;
        }
        .recurring { border-left: 5px solid #4a90e2; }
        .one-time { border-left: 5px solid #50e3c2; }
        .completed { text-decoration: line-through; color: #888; }
        .priority-low { background-color: #d4edda; }
        .priority-medium { background-color: #fff3cd; }
        .priority-high { background-color: #f8d7da; }

        /* Calendar Styling */
        #calendar {
            padding: 20px;
            background: white;
            border-radius: 10px;
        }
        #calendar-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 5px;
        }
        #calendar-table th {
            background: #4a90e2;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
        }
        #calendar-table td {
            height: 80px;
            vertical-align: top;
            background: #f8f9fa;
            border-radius: 5px;
            padding: 5px;
            transition: background 0.3s;
        }
        #calendar-table td:hover {
            background: #e9ecef;
        }
        #calendar-table td.bg-light {
            background: #d1e7dd;
        }
        .progress-bar {
            height: 20px;
            border-radius: 10px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .card { width: 100%; margin-bottom: 10px; }
            h1 { font-size: 1.5rem; }
            .navbar .nav-link { margin: 0 5px; }
            .btn { font-size: 0.9rem; padding: 0.25rem 0.5rem; }
        }
    </style>
</head>
<body onload="initializeApp()">
    <div class="container mt-4">
        <h1 class="text-center mb-4" style="color: #4a90e2; font-weight: bold;">Smart Task Manager</h1>

        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light mb-4">
            <div class="container-fluid">
                <div class="navbar-nav">
                    <a class="nav-link" href="#dashboard">Dashboard</a>
                    <a class="nav-link active" href="#hierarchical">Hierarchical</a>
                    <a class="nav-link" href="#calendar">Calendar</a>
                    <a class="nav-link" href="#list">List</a>
                </div>
                <button class="btn btn-success" onclick="showTaskModal()">Add Task</button>
                <button class="btn btn-success ms-2" onclick="showStandaloneTaskModal()">Add Standalone Task</button>
                <button class="btn btn-success ms-2" onclick="showGoalModal()">Add Goal</button>
                <button class="btn btn-success ms-2" onclick="showProjectModal()">Add Project</button>
            </div>
        </nav>

        <!-- Dashboard -->
        <div id="dashboard" class="card mb-4">
            <div class="card-body">
                <h5 class="text-primary">Dashboard</h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6>Total Goals</h6>
                                <p id="total-goals" class="display-6">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6>Total Projects</h6>
                                <p id="total-projects" class="display-6">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6>Upcoming Items</h6>
                                <p id="upcoming-items" class="display-6">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary mt-3" onclick="exportData()">Export Data</button>
                <input type="file" class="form-control mt-2" id="importFile" onchange="importData(event)">
                <button class="btn btn-danger mt-3" onclick="deleteAllData()">Delete All Data</button>
            </div>
        </div>

        <!-- Hierarchical View -->
        <div id="hierarchical" class="card mb-4">
            <div class="card-body">
                <h5 class="text-primary">Hierarchical View</h5>
                <div id="hierarchical-content"></div>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendar" class="card mb-4">
            <div class="card-body">
                <h5 class="text-primary">Calendar View</h5>
                <button class="btn btn-secondary mb-2" onclick="changeMonth(-1)">Previous</button>
                <button class="btn btn-secondary mb-2 ms-2" onclick="changeMonth(1)">Next</button>
                <table id="calendar-table" class="table">
                    <thead>
                        <tr><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr>
                    </thead>
                    <tbody id="calendar-body"></tbody>
                </table>
            </div>
        </div>

        <!-- List View -->
        <div id="list" class="card mb-4">
            <div class="card-body">
                <h5 class="text-primary">List View</h5>
                <div class="mb-3">
                    <input type="text" class="form-control" id="task-search" placeholder="Search tasks..." oninput="filterTasks()">
                </div>
                <div class="btn-group mb-3">
                    <button class="btn btn-outline-primary" onclick="filterTasks('all')">All</button>
                    <button class="btn btn-outline-primary" onclick="filterTasks('recurring')">Recurring</button>
                    <button class="btn btn-outline-primary" onclick="filterTasks('one-time')">One-Time</button>
                </div>
                <ul id="list-content" class="list-group"></ul>
            </div>
        </div>

        <!-- Task Modal -->
        <div id="taskModal" class="modal" style="display:none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background: #4a90e2; color: white;">
                        <h5 class="modal-title">Add New Task</h5>
                        <button class="btn-close" style="filter: invert(1);" onclick="hideTaskModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="task-form">
                            <div class="mb-3">
                                <select class="form-select" id="goal-select">
                                    <option value="">No Goal</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <select class="form-select" id="project-select">
                                    <option value="">No Project</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="task-title" placeholder="Task Title" required>
                            </div>
                            <div class="mb-3">
                                <textarea class="form-control" id="task-description" placeholder="Description"></textarea>
                            </div>
                            <div class="mb-3">
                                <select class="form-select" id="task-type" required>
                                    <option value="one-time">One-Time</option>
                                    <option value="recurring">Recurring</option>
                                </select>
                            </div>
                            <div class="mb-3" id="recurrence-options" style="display:none;">
                                <select class="form-select" id="recurrence-frequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <select class="form-select" id="task-priority">
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <input type="date" class="form-control" id="task-due-date" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Task</button>
                            <button type="button" class="btn btn-secondary" onclick="hideTaskModal()">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Standalone Task Modal -->
        <div id="standaloneTaskModal" class="modal" style="display:none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background: #4a90e2; color: white;">
                        <h5 class="modal-title">Add Standalone Task</h5>
                        <button class="btn-close" style="filter: invert(1);" onclick="hideStandaloneTaskModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="standalone-task-form">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="standalone-task-title" placeholder="Task Title" required>
                            </div>
                            <div class="mb-3">
                                <textarea class="form-control" id="standalone-task-description" placeholder="Description"></textarea>
                            </div>
                            <div class="mb-3">
                                <select class="form-select" id="standalone-task-type" required>
                                    <option value="one-time">One-Time</option>
                                    <option value="recurring">Recurring</option>
                                </select>
                            </div>
                            <div class="mb-3" id="standalone-recurrence-options" style="display:none;">
                                <select class="form-select" id="standalone-recurrence-frequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <select class="form-select" id="standalone-task-priority">
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <input type="date" class="form-control" id="standalone-task-due-date" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Task</button>
                            <button type="button" class="btn btn-secondary" onclick="hideStandaloneTaskModal()">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Goal Modal -->
        <div id="goalModal" class="modal" style="display:none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background: #4a90e2; color: white;">
                        <h5 class="modal-title">Add New Goal</h5>
                        <button class="btn-close" style="filter: invert(1);" onclick="hideGoalModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="goal-form">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="goal-title" placeholder="Goal Title" required>
                            </div>
                            <div class="mb-3">
                                <textarea class="form-control" id="goal-description" placeholder="Goal Description"></textarea>
                            </div>
                            <div class="mb-3">
                                <input type="date" class="form-control" id="goal-target-date">
                            </div>
                            <button type="submit" class="btn btn-primary">Add Goal</button>
                            <button type="button" class="btn btn-secondary" onclick="hideGoalModal()">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Modal -->
        <div id="projectModal" class="modal" style="display:none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background: #4a90e2; color: white;">
                        <h5 class="modal-title">Add New Project</h5>
                        <button class="btn-close" style="filter: invert(1);" onclick="hideProjectModal()"></button>
                    </div>
                    <div class="mb-3">
                        <select class="form-select" id="project-goal-select">
                            <option value="">No Goal</option>
                        </select>
                    </div>
                    <div class="modal-body">
                        <form id="project-form">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="project-title" placeholder="Project Title" required>
                            </div>
                            <div class="mb-3">
                                <textarea class="form-control" id="project-description" placeholder="Project Description"></textarea>
                            </div>
                            <div class="mb-3">
                                <input type="date" class="form-control" id="project-target-date">
                            </div>
                            <div class="mb-3">
                                <input type="number" class="form-control" id="project-progress" min="0" max="100" placeholder="Initial Progress (0-100)">
                            </div>
                            <button type="submit" class="btn btn-primary">Add Project</button>
                            <button type="button" class="btn btn-secondary" onclick="hideProjectModal()">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal" style="display:none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background: #4a90e2; color: white;">
                        <h5 class="modal-title" id="editModalTitle">Edit Item</h5>
                        <button class="btn-close" style="filter: invert(1);" onclick="hideEditModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-form">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="edit-title" placeholder="Title" required>
                            </div>
                            <div class="mb-3" id="edit-date-field">
                                <input type="date" class="form-control" id="edit-target-date">
                            </div>
                            <div class="mb-3" id="edit-progress-field" style="display:none;">
                                <input type="number" class="form-control" id="edit-progress" min="0" max="100" placeholder="Progress (0-100)">
                            </div>
                            <div class="mb-3" id="edit-priority-field" style="display:none;">
                                <select class="form-select" id="edit-priority">
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="mb-3" id="edit-type-field" style="display:none;">
                                <select class="form-select" id="edit-type">
                                    <option value="one-time">One-Time</option>
                                    <option value="recurring">Recurring</option>
                                </select>
                            </div>
                            <div class="mb-3" id="edit-recurrence-field" style="display:none;">
                                <select class="form-select" id="edit-recurrence-frequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="mb-3" id="edit-description-field">
                                <textarea class="form-control" id="edit-description" placeholder="Description"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" class="btn btn-secondary" onclick="hideEditModal()">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let data = JSON.parse(localStorage.getItem('taskData')) || { goals: [], archived: [], standaloneTasks: [] };
        let currentMonth = new Date('2025-07-14T13:25:00Z');

        function initializeApp() {
            updateDashboard();
            renderHierarchical();
            renderCalendar();
            renderList();
            populateGoalSelect();
            document.getElementById('task-type').onchange = toggleRecurrenceOptions;
            document.getElementById('standalone-task-type').onchange = toggleStandaloneRecurrenceOptions;
            document.getElementById('task-form').onsubmit = function(e) { e.preventDefault(); addTask(); };
            document.getElementById('standalone-task-form').onsubmit = function(e) { e.preventDefault(); addStandaloneTask(); };
            document.getElementById('goal-form').onsubmit = function(e) { e.preventDefault(); addGoal(); };
            document.getElementById('project-form').onsubmit = function(e) { e.preventDefault(); addProject(); };
            document.getElementById('edit-form').onsubmit = function(e) { e.preventDefault(); saveEdit(); };
            checkDueDates();
        }

        function updateDashboard() {
            const totalGoals = data.goals.length;
            const totalProjects = data.goals.reduce((sum, goal) => sum + goal.projects.length, 0);
            const upcomingItems = data.goals.reduce((sum, goal) => sum + goal.projects.reduce((pSum, project) => pSum + (new Date(project.targetDate || '9999-12-31') <= new Date('2025-07-14T13:25:00Z').getTime() + 7 * 24 * 60 * 60 * 1000 ? 1 : 0) + project.tasks.filter(task => {
                const dueDate = new Date(task.dueDate);
                const today = new Date('2025-07-14T13:25:00Z');
                today.setHours(0, 0, 0, 0);
                dueDate.setHours(0, 0, 0, 0);
                return dueDate <= new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000) && !task.archived;
            }).length, 0) + (new Date(goal.targetDate || '9999-12-31') <= new Date('2025-07-14T13:25:00Z').getTime() + 7 * 24 * 60 * 60 * 1000 ? 1 : 0), 0) +
                data.standaloneTasks.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    const today = new Date('2025-07-14T13:25:00Z');
                    today.setHours(0, 0, 0, 0);
                    dueDate.setHours(0, 0, 0, 0);
                    return dueDate <= new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000) && !task.archived;
                }).length;

            document.getElementById('total-goals').textContent = totalGoals;
            document.getElementById('total-projects').textContent = totalProjects;
            document.getElementById('upcoming-items').textContent = upcomingItems;
        }

        function renderHierarchical() {
            const content = document.getElementById('hierarchical-content');
            content.innerHTML = '';
            data.goals.forEach((goal, goalIndex) => {
                const goalDiv = document.createElement('div');
                goalDiv.className = 'card mb-2 goal-card';
                goalDiv.innerHTML = `<div class="card-body"><h6>${goal.title} (Target: ${goal.targetDate || 'N/A'})<br><small>${goal.description || 'No description'}</small> <button class="btn btn-warning btn-sm float-end me-2" onclick="editGoal(${goalIndex})">Edit</button><button class="btn btn-danger btn-sm float-end" onclick="deleteGoal(${goalIndex})">Delete</button></h6></div>`;
                const projectsDiv = document.createElement('div');
                goal.projects.forEach((project, projectIndex) => {
                    const projectDiv = document.createElement('div');
                    projectDiv.className = 'card ms-3 mb-2 project-card';
                    projectDiv.innerHTML = `<div class="card-body"><h6>${project.title} (Target: ${project.targetDate || 'N/A'}, Progress: ${project.progress || 0}%)<br><small>${project.description || 'No description'}</small> <div class="progress mt-2" style="height: 10px;"><div class="progress-bar bg-success" role="progressbar" style="width: ${project.progress}%;" aria-valuenow="${project.progress}" aria-valuemin="0" aria-valuemax="100"></div></div><button class="btn btn-warning btn-sm float-end me-2" onclick="editProject(${goalIndex}, ${projectIndex})">Edit</button><button class="btn btn-danger btn-sm float-end me-2" onclick="deleteProject(${goalIndex}, ${projectIndex})">Delete</button></h6></div>`;
                    const tasksUl = document.createElement('ul');
                    tasksUl.className = 'list-group list-group-flush';
                    project.tasks.forEach((task, taskIndex) => {
                        if (!task.archived) {
                            const taskLi = document.createElement('li');
                            taskLi.className = `list-group-item ${task.type} ${task.completed ? 'completed' : ''} priority-${task.priority}`;
                            taskLi.innerHTML = `
                                ${task.title} (${task.type === 'recurring' ? 'Recurring' : 'One-Time'}) (Due: ${task.dueDate}, Priority: ${task.priority})
                                <br>Status: ${task.completed ? 'Completed' : 'Pending'}
                                <button class="btn btn-sm btn-success ms-2" onclick="toggleTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Toggle</button>
                                <button class="btn btn-sm btn-warning ms-2" onclick="editTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Edit</button>
                                <button class="btn btn-sm btn-danger ms-2" onclick="deleteTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Delete</button>
                                <button class="btn btn-sm btn-warning ms-2" onclick="archiveTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Archive</button>
                            `;
                            tasksUl.appendChild(taskLi);
                        }
                    });
                    projectDiv.appendChild(tasksUl);
                    projectsDiv.appendChild(projectDiv);
                });
                goalDiv.appendChild(projectsDiv);
                content.appendChild(goalDiv);
                const addProjectBtn = document.createElement('button');
                addProjectBtn.className = 'btn btn-success ms-3 mb-2';
                addProjectBtn.textContent = 'Add Project';
                addProjectBtn.onclick = () => showProjectModal(goalIndex);
                content.appendChild(addProjectBtn);
            });
        }

        function renderCalendar() {
            const tbody = document.getElementById('calendar-body');
            tbody.innerHTML = '';
            const firstDay = new Date(currentMonth.getTime());
            firstDay.setDate(1);
            const lastDay = new Date(firstDay.getTime());
            lastDay.setMonth(lastDay.getMonth() + 1);
            lastDay.setDate(0);
            const startDay = new Date(firstDay.getTime());
            startDay.setDate(1 - firstDay.getDay() + (firstDay.getDay() === 0 ? -6 : 1));
            for (let i = 0; i < Math.ceil((lastDay.getDate() + (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1)) / 7); i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    const date = new Date(startDay.getTime() + (i * 7 + j) * 24 * 60 * 60 * 1000);
                    if (date.getMonth() === firstDay.getMonth()) {
                        cell.textContent = date.getDate();
                        if (date.toDateString() === new Date('2025-07-14T13:25:00Z').toDateString()) cell.style.background = '#ffeb3b';
                        const items = [
                            ...data.goals.filter(goal => new Date(goal.targetDate || '9999-12-31').toDateString() === date.toDateString()),
                            ...data.goals.reduce((all, goal) => all.concat(goal.projects.filter(project => new Date(project.targetDate || '9999-12-31').toDateString() === date.toDateString())), []),
                            ...data.goals.reduce((all, goal) => all.concat(goal.projects.reduce((pAll, project) => pAll.concat(project.tasks.filter(task => new Date(task.dueDate).toDateString() === date.toDateString() && !task.archived)), [])), []),
                            ...data.standaloneTasks.filter(task => new Date(task.dueDate).toDateString() === date.toDateString() && !task.archived)
                        ];
                        if (items.length) {
                            cell.className = 'bg-light';
                            items.forEach(item => {
                                const itemSpan = document.createElement('div');
                                if (item.type) {
                                    itemSpan.className = `${item.type} ${item.completed ? 'completed' : ''} priority-${item.priority || 'medium'}`;
                                    itemSpan.textContent = `${item.title} (${item.type})`;
                                } else if (item.targetDate) {
                                    itemSpan.textContent = `${item.title || item.name} (Target)`;
                                }
                                cell.appendChild(itemSpan);
                            });
                        }
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            }
        }

        function renderList(filter = 'all') {
            const content = document.getElementById('list-content');
            content.innerHTML = '';
            data.goals.forEach((goal, goalIndex) => {
                goal.projects.forEach((project, projectIndex) => {
                    project.tasks.forEach((task, taskIndex) => {
                        if (!task.archived && (filter === 'all' || task.type === filter)) {
                            const taskLi = document.createElement('li');
                            taskLi.className = `list-group-item ${task.type} ${task.completed ? 'completed' : ''} priority-${task.priority}`;
                            taskLi.innerHTML = `
                                ${task.title} (Goal: ${goal.title}, Project: ${project.title})
                                <br>Due: ${task.dueDate} | Priority: ${task.priority} | Status: ${task.completed ? 'Completed' : 'Pending'}
                                <button class="btn btn-sm btn-success ms-2" onclick="toggleTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Toggle</button>
                                <button class="btn btn-sm btn-warning ms-2" onclick="editTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Edit</button>
                                <button class="btn btn-sm btn-danger ms-2" onclick="deleteTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Delete</button>
                                <button class="btn btn-sm btn-warning ms-2" onclick="archiveTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Archive</button>
                            `;
                            content.appendChild(taskLi);
                        }
                    });
                });
            });
            data.standaloneTasks.forEach((task, taskIndex) => {
                if (!task.archived && (filter === 'all' || task.type === filter)) {
                    const taskLi = document.createElement('li');
                    taskLi.className = `list-group-item ${task.type} ${task.completed ? 'completed' : ''} priority-${task.priority}`;
                    taskLi.innerHTML = `
                        ${task.title} (Standalone)
                        <br>Due: ${task.dueDate} | Priority: ${task.priority} | Status: ${task.completed ? 'Completed' : 'Pending'}
                        <button class="btn btn-sm btn-success ms-2" onclick="toggleStandaloneTask(${taskIndex})">Toggle</button>
                        <button class="btn btn-sm btn-warning ms-2" onclick="editStandaloneTask(${taskIndex})">Edit</button>
                        <button class="btn btn-sm btn-danger ms-2" onclick="deleteStandaloneTask(${taskIndex})">Delete</button>
                        <button class="btn btn-sm btn-warning ms-2" onclick="archiveStandaloneTask(${taskIndex})">Archive</button>
                    `;
                    content.appendChild(taskLi);
                }
            });
        }

        function addGoal() {
            const title = document.getElementById('goal-title').value;
            const description = document.getElementById('goal-description').value;
            const targetDate = document.getElementById('goal-target-date').value || null;
            if (title) {
                data.goals.push({ title, description: description || '', targetDate, projects: [] });
                try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
                document.getElementById('goal-form').reset();
                hideGoalModal();
                renderHierarchical();
                updateDashboard();
                populateGoalSelect();
                populateProjectGoalSelect();
            } else {
                alert('Please enter a title.');
            }
        }

        function addProject(goalIndex = null) {
            const title = document.getElementById('project-title').value;
            const description = document.getElementById('project-description').value;
            const targetDate = document.getElementById('project-target-date').value || null;
            const progress = parseInt(document.getElementById('project-progress').value) || 0;
            const goalSelect = document.getElementById('project-goal-select').value;
            if (title) {
                if (goalSelect !== '' && goalIndex === null) {
                    goalIndex = goalSelect;
                }
                if (goalIndex !== null) {
                    data.goals[goalIndex].projects.push({ title, description: description || '', targetDate, tasks: [], progress });
                } else {
                    data.goals.push({ title: 'Unnamed Goal', targetDate: null, description: '', projects: [{ title, description: description || '', targetDate, tasks: [], progress }] });
                }
                try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
                document.getElementById('project-form').reset();
                hideProjectModal();
                renderHierarchical();
                updateDashboard();
                populateGoalSelect();
                populateProjectGoalSelect();
            } else {
                alert('Please enter a title.');
            }
        }

        function addTask() {
            const goalIndex = document.getElementById('goal-select').value || null;
            const projectIndex = document.getElementById('project-select').value || null;
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const type = document.getElementById('task-type').value;
            const priority = document.getElementById('task-priority').value;
            const dueDate = document.getElementById('task-due-date').value;
            if (title && dueDate) {
                if (goalIndex !== null && projectIndex !== null) {
                    const tasksArray = data.goals[goalIndex].projects[projectIndex].tasks;
                    tasksArray.push({ title, description, type, priority, dueDate, completed: false, archived: false });
                    if (type === 'recurring') {
                        const frequency = document.getElementById('recurrence-frequency').value;
                        let interval;
                        if (frequency === 'daily') interval = 1 * 24 * 60 * 60 * 1000;
                        else if (frequency === 'weekly') interval = 7 * 24 * 60 * 60 * 1000;
                        else if (frequency === 'monthly') interval = 30 * 24 * 60 * 60 * 1000;
                        const nextDate = new Date(new Date(dueDate).getTime() + interval).toISOString().split('T')[0];
                        tasksArray.push({ title, description, type, priority, dueDate: nextDate, completed: false, archived: false });
                    }
                } else {
                    alert('Please select a Goal and Project or use Add Standalone Task for independent tasks.');
                    return;
                }
                try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
                document.getElementById('task-form').reset();
                hideTaskModal();
                renderHierarchical();
                renderCalendar();
                renderList();
                updateDashboard();
            } else {
                alert('Please fill all required fields.');
            }
        }

        function addStandaloneTask() {
            const title = document.getElementById('standalone-task-title').value;
            const description = document.getElementById('standalone-task-description').value;
            const type = document.getElementById('standalone-task-type').value;
            const priority = document.getElementById('standalone-task-priority').value;
            const dueDate = document.getElementById('standalone-task-due-date').value;
            if (title && dueDate) {
                data.standaloneTasks.push({ title, description, type, priority, dueDate, completed: false, archived: false });
                if (type === 'recurring') {
                    const frequency = document.getElementById('standalone-recurrence-frequency').value;
                    let interval;
                    if (frequency === 'daily') interval = 1 * 24 * 60 * 60 * 1000;
                    else if (frequency === 'weekly') interval = 7 * 24 * 60 * 60 * 1000;
                    else if (frequency === 'monthly') interval = 30 * 24 * 60 * 60 * 1000;
                    const nextDate = new Date(new Date(dueDate).getTime() + interval).toISOString().split('T')[0];
                    data.standaloneTasks.push({ title, description, type, priority, dueDate: nextDate, completed: false, archived: false });
                }
                try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
                document.getElementById('standalone-task-form').reset();
                hideStandaloneTaskModal();
                renderCalendar();
                renderList();
                updateDashboard();
            } else {
                alert('Please fill all required fields.');
            }
        }

        function toggleTask(goalIndex, projectIndex, taskIndex) {
            data.goals[goalIndex].projects[projectIndex].tasks[taskIndex].completed = !data.goals[goalIndex].projects[projectIndex].tasks[taskIndex].completed;
            try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
            renderHierarchical();
            renderList();
            renderCalendar();
        }

        function toggleStandaloneTask(taskIndex) {
            data.standaloneTasks[taskIndex].completed = !data.standaloneTasks[taskIndex].completed;
            try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
            renderList();
            renderCalendar();
        }

        function deleteGoal(goalIndex) {
            if (confirm('Delete this goal and all its projects/tasks?')) {
                data.goals.splice(goalIndex, 1);
                try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
                renderHierarchical();
                updateDashboard();
                populateGoalSelect();
                populateProjectGoalSelect();
            }
        }

        function deleteProject(goalIndex, projectIndex) {
            if (confirm('Delete this project and all its tasks?')) {
                data.goals[goalIndex].projects.splice(projectIndex, 1);
                try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
                renderHierarchical();
                updateDashboard();
                populateProjectGoalSelect();
            }
        }

        function deleteTask(goalIndex, projectIndex, taskIndex) {
            if (confirm('Delete this task?')) {
                data.goals[goalIndex].projects[projectIndex].tasks.splice(taskIndex, 1);
                try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
                renderHierarchical();
                renderList();
                renderCalendar();
            }
        }

        function deleteStandaloneTask(taskIndex) {
            if (confirm('Delete this standalone task?')) {
                data.standaloneTasks.splice(taskIndex, 1);
                try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
                renderList();
                renderCalendar();
            }
        }

        function archiveTask(goalIndex, projectIndex, taskIndex) {
            data.goals[goalIndex].projects[projectIndex].tasks[taskIndex].archived = true;
            data.archived.push(data.goals[goalIndex].projects[projectIndex].tasks[taskIndex]);
            data.goals[goalIndex].projects[projectIndex].tasks.splice(taskIndex, 1);
            try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
            renderHierarchical();
            renderList();
            renderCalendar();
        }

        function archiveStandaloneTask(taskIndex) {
            data.standaloneTasks[taskIndex].archived = true;
            data.archived.push(data.standaloneTasks[taskIndex]);
            data.standaloneTasks.splice(taskIndex, 1);
            try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
            renderList();
            renderCalendar();
        }

        function filterTasks(filter = 'all') {
            const searchTerm = document.getElementById('task-search').value.toLowerCase();
            const content = document.getElementById('list-content');
            content.innerHTML = '';
            data.goals.forEach((goal, goalIndex) => {
                goal.projects.forEach((project, projectIndex) => {
                    project.tasks.forEach((task, taskIndex) => {
                        if (!task.archived && (filter === 'all' || task.type === filter) && 
                            (task.title.toLowerCase().includes(searchTerm) || 
                             (task.description && task.description.toLowerCase().includes(searchTerm)))) {
                            const taskLi = document.createElement('li');
                            taskLi.className = `list-group-item ${task.type} ${task.completed ? 'completed' : ''} priority-${task.priority}`;
                            taskLi.innerHTML = `
                                ${task.title} (Goal: ${goal.title}, Project: ${project.title})
                                <br>Due: ${task.dueDate} | Priority: ${task.priority} | Status: ${task.completed ? 'Completed' : 'Pending'}
                                <button class="btn btn-sm btn-success ms-2" onclick="toggleTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Toggle</button>
                                <button class="btn btn-sm btn-warning ms-2" onclick="editTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Edit</button>
                                <button class="btn btn-sm btn-danger ms-2" onclick="deleteTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Delete</button>
                                <button class="btn btn-sm btn-warning ms-2" onclick="archiveTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Archive</button>
                            `;
                            content.appendChild(taskLi);
                        }
                    });
                });
            });
            data.standaloneTasks.forEach((task, taskIndex) => {
                if (!task.archived && (filter === 'all' || task.type === filter) && 
                    (task.title.toLowerCase().includes(searchTerm) || 
                     (task.description && task.description.toLowerCase().includes(searchTerm)))) {
                    const taskLi = document.createElement('li');
                    taskLi.className = `list-group-item ${task.type} ${task.completed ? 'completed' : ''} priority-${task.priority}`;
                    taskLi.innerHTML = `
                        ${task.title} (Standalone)
                        <br>Due: ${task.dueDate} | Priority: ${task.priority} | Status: ${task.completed ? 'Completed' : 'Pending'}
                        <button class="btn btn-sm btn-success ms-2" onclick="toggleStandaloneTask(${taskIndex})">Toggle</button>
                        <button class="btn btn-sm btn-warning ms-2" onclick="editStandaloneTask(${taskIndex})">Edit</button>
                        <button class="btn btn-sm btn-danger ms-2" onclick="deleteStandaloneTask(${taskIndex})">Delete</button>
                        <button class="btn btn-sm btn-warning ms-2" onclick="archiveStandaloneTask(${taskIndex})">Archive</button>
                    `;
                    content.appendChild(taskLi);
                }
            });
        }

        function populateGoalSelect() {
            const goalSelect = document.getElementById('goal-select');
            goalSelect.innerHTML = '<option value="">No Goal</option>';
            data.goals.forEach((goal, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = goal.title;
                goalSelect.appendChild(option);
            });
        }

        function populateProjectSelect() {
            const projectSelect = document.getElementById('project-select');
            projectSelect.innerHTML = '<option value="">No Project</option>';
            const goalIndex = document.getElementById('goal-select').value;
            if (goalIndex !== '') {
                data.goals[goalIndex].projects.forEach((project, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = project.title;
                    projectSelect.appendChild(option);
                });
            }
        }

        function populateProjectGoalSelect() {
            const goalSelect = document.getElementById('project-goal-select');
            goalSelect.innerHTML = '<option value="">No Goal</option>';
            data.goals.forEach((goal, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = goal.title;
                goalSelect.appendChild(option);
            });
        }

        function showTaskModal() {
            populateGoalSelect();
            document.getElementById('taskModal').style.display = 'block';
            toggleRecurrenceOptions();
        }

        function hideTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('task-form').reset();
        }

        function showStandaloneTaskModal() {
            document.getElementById('standaloneTaskModal').style.display = 'block';
            toggleStandaloneRecurrenceOptions();
        }

        function hideStandaloneTaskModal() {
            document.getElementById('standaloneTaskModal').style.display = 'none';
            document.getElementById('standalone-task-form').reset();
        }

        function showGoalModal() {
            document.getElementById('goalModal').style.display = 'block';
            document.getElementById('goal-form').reset();
        }

        function hideGoalModal() {
            document.getElementById('goalModal').style.display = 'none';
        }

        function showProjectModal(goalIndex = null) {
            populateProjectGoalSelect();
            if (goalIndex !== null) {
                document.getElementById('project-goal-select').value = goalIndex;
            }
            document.getElementById('projectModal').style.display = 'block';
            document.getElementById('project-form').reset();
        }

        function hideProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        function toggleRecurrenceOptions() {
            const type = document.getElementById('task-type').value;
            document.getElementById('recurrence-options').style.display = type === 'recurring' ? 'block' : 'none';
        }

        function toggleStandaloneRecurrenceOptions() {
            const type = document.getElementById('standalone-task-type').value;
            document.getElementById('standalone-recurrence-options').style.display = type === 'recurring' ? 'block' : 'none';
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", "task-data.json");
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            document.body.removeChild(downloadAnchor);
        }

        function importData(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                data = JSON.parse(e.target.result);
                localStorage.setItem('taskData', JSON.stringify(data));
                renderHierarchical();
                renderCalendar();
                renderList();
                updateDashboard();
                populateGoalSelect();
                populateProjectGoalSelect();
            };
            reader.readAsText(file);
        }

        function deleteAllData() {
            if (confirm('Are you sure you want to delete all data? This cannot be undone.')) {
                data = { goals: [], archived: [], standaloneTasks: [] };
                localStorage.setItem('taskData', JSON.stringify(data));
                renderHierarchical();
                renderCalendar();
                renderList();
                updateDashboard();
                populateGoalSelect();
                populateProjectGoalSelect();
            }
        }

        function checkDueDates() {
            const today = new Date('2025-07-14T13:25:00Z');
            const tasks = [...data.goals.flatMap(g => g.projects.flatMap(p => p.tasks)), ...data.standaloneTasks];
            tasks.forEach(task => {
                const dueDate = new Date(task.dueDate);
                if (dueDate - today <= 24 * 60 * 60 * 1000 && !task.completed && !task.archived) {
                    alert(`Task due soon: ${task.title} (Due: ${task.dueDate})`);
                }
            });
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function editGoal(goalIndex) {
            const goal = data.goals[goalIndex];
            document.getElementById('editModalTitle').textContent = 'Edit Goal';
            document.getElementById('edit-title').value = goal.title;
            document.getElementById('edit-description').value = goal.description || '';
            document.getElementById('edit-target-date').value = goal.targetDate || '';
            document.getElementById('edit-date-field').style.display = 'block';
            document.getElementById('edit-progress-field').style.display = 'none';
            document.getElementById('edit-priority-field').style.display = 'none';
            document.getElementById('edit-type-field').style.display = 'none';
            document.getElementById('edit-recurrence-field').style.display = 'none';
            document.getElementById('edit-description-field').style.display = 'block';
            document.getElementById('editModal').style.display = 'block';
            window.editData = { type: 'goal', index: goalIndex };
        }

        function editProject(goalIndex, projectIndex) {
            const project = data.goals[goalIndex].projects[projectIndex];
            document.getElementById('editModalTitle').textContent = 'Edit Project';
            document.getElementById('edit-title').value = project.title;
            document.getElementById('edit-description').value = project.description || '';
            document.getElementById('edit-target-date').value = project.targetDate || '';
            document.getElementById('edit-progress').value = project.progress || 0;
            document.getElementById('edit-date-field').style.display = 'block';
            document.getElementById('edit-progress-field').style.display = 'block';
            document.getElementById('edit-priority-field').style.display = 'none';
            document.getElementById('edit-type-field').style.display = 'none';
            document.getElementById('edit-recurrence-field').style.display = 'none';
            document.getElementById('edit-description-field').style.display = 'block';
            document.getElementById('editModal').style.display = 'block';
            window.editData = { type: 'project', goalIndex, projectIndex };
        }

        function editTask(goalIndex, projectIndex, taskIndex) {
            const task = data.goals[goalIndex].projects[projectIndex].tasks[taskIndex];
            document.getElementById('editModalTitle').textContent = 'Edit Task';
            document.getElementById('edit-title').value = task.title;
            document.getElementById('edit-description').value = task.description || '';
            document.getElementById('edit-target-date').value = task.dueDate;
            document.getElementById('edit-priority').value = task.priority;
            document.getElementById('edit-type').value = task.type;
            document.getElementById('edit-recurrence-frequency').value = task.type === 'recurring' ? 'weekly' : 'daily';
            document.getElementById('edit-date-field').style.display = 'block';
            document.getElementById('edit-progress-field').style.display = 'none';
            document.getElementById('edit-priority-field').style.display = 'block';
            document.getElementById('edit-type-field').style.display = 'block';
            document.getElementById('edit-recurrence-field').style.display = task.type === 'recurring' ? 'block' : 'none';
            document.getElementById('edit-description-field').style.display = 'block';
            document.getElementById('editModal').style.display = 'block';
            window.editData = { type: 'task', goalIndex, projectIndex, taskIndex };
        }

        function editStandaloneTask(taskIndex) {
            const task = data.standaloneTasks[taskIndex];
            document.getElementById('editModalTitle').textContent = 'Edit Standalone Task';
            document.getElementById('edit-title').value = task.title;
            document.getElementById('edit-description').value = task.description || '';
            document.getElementById('edit-target-date').value = task.dueDate;
            document.getElementById('edit-priority').value = task.priority;
            document.getElementById('edit-type').value = task.type;
            document.getElementById('edit-recurrence-frequency').value = task.type === 'recurring' ? 'weekly' : 'daily';
            document.getElementById('edit-date-field').style.display = 'block';
            document.getElementById('edit-progress-field').style.display = 'none';
            document.getElementById('edit-priority-field').style.display = 'block';
            document.getElementById('edit-type-field').style.display = 'block';
            document.getElementById('edit-recurrence-field').style.display = task.type === 'recurring' ? 'block' : 'none';
            document.getElementById('edit-description-field').style.display = 'block';
            document.getElementById('editModal').style.display = 'block';
            window.editData = { type: 'standaloneTask', taskIndex };
        }

        function hideEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('edit-form').reset();
        }

        function saveEdit() {
            const title = document.getElementById('edit-title').value;
            const description = document.getElementById('edit-description').value || null;
            const targetDate = document.getElementById('edit-target-date').value || null;
            const progress = document.getElementById('edit-progress') ? parseInt(document.getElementById('edit-progress').value) || 0 : null;
            const priority = document.getElementById('edit-priority') ? document.getElementById('edit-priority').value : null;
            const type = document.getElementById('edit-type') ? document.getElementById('edit-type').value : null;
            const recurrenceFrequency = document.getElementById('edit-recurrence-frequency') ? document.getElementById('edit-recurrence-frequency').value : null;

            if (window.editData.type === 'goal') {
                data.goals[window.editData.index].title = title;
                data.goals[window.editData.index].description = description;
                data.goals[window.editData.index].targetDate = targetDate;
            } else if (window.editData.type === 'project') {
                data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].title = title;
                data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].description = description;
                data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].targetDate = targetDate;
                if (progress !== null) data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].progress = progress;
            } else if (window.editData.type === 'task') {
                const task = data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].tasks[window.editData.taskIndex];
                task.title = title;
                task.description = description;
                task.dueDate = targetDate;
                task.priority = priority;
                task.type = type;
                if (type === 'recurring' && task.type !== 'recurring') {
                    let interval;
                    if (recurrenceFrequency === 'daily') interval = 1 * 24 * 60 * 60 * 1000;
                    else if (recurrenceFrequency === 'weekly') interval = 7 * 24 * 60 * 60 * 1000;
                    else if (recurrenceFrequency === 'monthly') interval = 30 * 24 * 60 * 60 * 1000;
                    const nextDate = new Date(new Date(targetDate).getTime() + interval).toISOString().split('T')[0];
                    data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].tasks.push({ title, description, type, priority, dueDate: nextDate, completed: false, archived: false });
                } else if (type !== 'recurring' && task.type === 'recurring') {
                    data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].tasks.splice(window.editData.taskIndex + 1, 1);
                }
            } else if (window.editData.type === 'standaloneTask') {
                const task = data.standaloneTasks[window.editData.taskIndex];
                task.title = title;
                task.description = description;
                task.dueDate = targetDate;
                task.priority = priority;
                task.type = type;
                if (type === 'recurring' && task.type !== 'recurring') {
                    let interval;
                    if (recurrenceFrequency === 'daily') interval = 1 * 24 * 60 * 60 * 1000;
                    else if (recurrenceFrequency === 'weekly') interval = 7 * 24 * 60 * 60 * 1000;
                    else if (recurrenceFrequency === 'monthly') interval = 30 * 24 * 60 * 60 * 1000;
                    const nextDate = new Date(new Date(targetDate).getTime() + interval).toISOString().split('T')[0];
                    data.standaloneTasks.push({ title, description, type, priority, dueDate: nextDate, completed: false, archived: false });
                } else if (type !== 'recurring' && task.type === 'recurring') {
                    data.standaloneTasks.splice(window.editData.taskIndex + 1, 1);
                }
            }

            try { localStorage.setItem('taskData', JSON.stringify(data)); } catch(e) { alert('Storage error, clear browser data.'); }
            hideEditModal();
            renderHierarchical();
            renderCalendar();
            renderList();
            updateDashboard();
        }

        document.getElementById('goal-select').onchange = populateProjectSelect;
    </script>
</body>
</html>
