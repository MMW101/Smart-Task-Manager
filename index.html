<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Task Manager - Enhanced Version</title>
    <link rel="manifest" href="/manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            padding: 15px;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        .navbar {
            background: linear-gradient(90deg, #4a90e2, #50e3c2);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .navbar .nav-link {
            color: white !important;
            margin: 0 10px;
            font-weight: 500;
            padding: 8px 15px;
        }
        .navbar .nav-link:hover {
            color: #ffd700 !important;
            text-decoration: underline;
        }
        .btn-success {
            background-color: #4a90e2;
            border: none;
            padding: 6px 12px;
        }
        .btn-success:hover {
            background-color: #357abd;
        }
        .btn-primary {
            background-color: #50e3c2;
            border: none;
            padding: 6px 12px;
        }
        .btn-primary:hover {
            background-color: #33c4a3;
        }
        .btn-danger {
            background-color: #dc3545;
            border: none;
            padding: 6px 12px;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .recurring { border-left: 5px solid #4a90e2; }
        .one-time { border-left: 5px solid #50e3c2; }
        .completed { text-decoration: line-through; color: #888; }
        .priority-low { background-color: #d4edda; }
        .priority-medium { background-color: #fff3cd; }
        .priority-high { background-color: #f8d7da; }

        /* Hierarchical View Styling */
        .goal-card {
            background: linear-gradient(135deg, #e6f0fa, #ffffff);
            padding: 12px;
            margin-bottom: 10px;
        }
        .project-card {
            background: linear-gradient(135deg, #f0f4f8, #ffffff);
            margin-left: 20px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .task-item {
            background: linear-gradient(135deg, #f9f9f9, #ffffff);
            margin-left: 40px;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 6px;
        }
        .collapsible {
            cursor: pointer;
            padding: 8px;
            margin-bottom: 5px;
        }
        .collapsible:hover {
            background-color: #e9ecef;
        }
        .content {
            display: none;
            padding-left: 20px;
        }
        .content.show {
            display: block;
        }
        .small {
            font-size: 0.85em;
            color: #666;
        }

        /* Calendar Styling */
        #calendar {
            padding: 15px;
            background: white;
            border-radius: 10px;
        }
        #calendar-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 5px;
        }
        #calendar-table th {
            background: #4a90e2;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
        }
        #calendar-table td {
            height: 80px;
            vertical-align: top;
            background: #f8f9fa;
            border-radius: 5px;
            padding: 6px;
            transition: background 0.3s;
        }
        #calendar-table td:hover {
            background: #e9ecef;
        }
        #calendar-table td.bg-light {
            background: #d1e7dd;
        }
        .progress-bar {
            height: 18px;
            border-radius: 10px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .navbar-nav { display: none; }
            .navbar-toggler { display: block; }
            .navbar-nav.show { display: flex; flex-direction: column; }
            .card { margin-bottom: 10px; padding: 10px; }
            h1 { font-size: 1.6rem; }
            h5 { font-size: 1.2rem; }
            h6 { font-size: 1.0rem; }
            .col-md-4 { margin-bottom: 10px; }
            .btn { min-width: 70px; margin: 2px; font-size: 0.8rem; padding: 4px 8px; }
            .project-card { margin-left: 10px; }
            .task-item { margin-left: 20px; }
            .modal-content { padding: 10px; }
            .modal-body .mb-3 { margin-bottom: 6px; }
            .form-control, .form-select { font-size: 0.9rem; padding: 6px; }
            .navbar .nav-link { padding: 6px 10px; }
        }
    </style>
</head>
<body onload="initializeApp()">
    <div class="container mt-3">
        <h1 class="text-center mb-3" style="color: #4a90e2; font-weight: bold;">Smart Task Manager</h1>

        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light mb-3">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <div class="navbar-nav">
                        <a class="nav-link" href="#dashboard">Dashboard</a>
                        <a class="nav-link active" href="#hierarchical">Hierarchical</a>
                        <a class="nav-link" href="#calendar">Calendar</a>
                        <a class="nav-link" href="#list">List</a>
                    </div>
                </div>
                <div class="d-flex">
                    <button class="btn btn-success me-2" onclick="showTaskModal()">Add Task</button>
                    <button class="btn btn-success me-2" onclick="showStandaloneTaskModal()">Add Standalone</button>
                    <button class="btn btn-success me-2" onclick="showGoalModal()">Add Goal</button>
                    <button class="btn btn-success" onclick="showProjectModal()">Add Project</button>
                </div>
            </div>
        </nav>

        <!-- Dashboard -->
        <div id="dashboard" class="card mb-3">
            <div class="card-body">
                <h5 class="text-primary mb-3">Dashboard</h5>
                <div class="row g-3">
                    <div class="col-md-4 col-12">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6>Total Goals</h6>
                                <p id="total-goals" class="display-6">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-12">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6>Total Projects</h6>
                                <p id="total-projects" class="display-6">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-12">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6>Upcoming Items</h6>
                                <p id="upcoming-items" class="display-6">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="exportData()">Export Data</button>
                    <input type="file" class="form-control d-inline w-auto" id="importFile" onchange="importData(event)" style="max-width: 200px;">
                    <button class="btn btn-danger me-2" onclick="deleteAllData()">Delete All Data</button>
                    <button class="btn btn-primary" onclick="exportToCalendar()">Export to Calendar</button>
                </div>
            </div>
        </div>

        <!-- Hierarchical View -->
        <div id="hierarchical" class="card mb-3">
            <div class="card-body">
                <h5 class="text-primary mb-3">Hierarchical View</h5>
                <div id="hierarchical-content"></div>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendar" class="card mb-3">
            <div class="card-body">
                <h5 class="text-primary mb-3">Calendar View</h5>
                <div class="d-flex mb-2">
                    <button class="btn btn-secondary me-2" onclick="changeMonth(-1)">Previous</button>
                    <button class="btn btn-secondary" onclick="changeMonth(1)">Next</button>
                </div>
                <table id="calendar-table" class="table">
                    <thead>
                        <tr><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr>
                    </thead>
                    <tbody id="calendar-body"></tbody>
                </table>
            </div>
        </div>

        <!-- List View -->
        <div id="list" class="card mb-3">
            <div class="card-body">
                <h5 class="text-primary mb-3">List View</h5>
                <div class="mb-2">
                    <input type="text" class="form-control" id="task-search" placeholder="Search tasks..." oninput="filterTasks()">
                </div>
                <div class="btn-group mb-2" role="group">
                    <button class="btn btn-outline-primary" onclick="filterTasks('all')">All</button>
                    <button class="btn btn-outline-primary" onclick="filterTasks('recurring')">Recurring</button>
                    <button class="btn btn-outline-primary" onclick="filterTasks('one-time')">One-Time</button>
                </div>
                <ul id="list-content" class="list-group"></ul>
            </div>
        </div>

        <!-- Task Modal -->
        <div id="taskModal" class="modal" style="display:none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background: #4a90e2; color: white;">
                        <h5 class="modal-title">Add New Task</h5>
                        <button type="button" class="btn-close" style="filter: invert(1);" onclick="hideTaskModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="task-form" onsubmit="event.preventDefault(); addTask();">
                            <div class="mb-2">
                                <select class="form-select" id="goal-select" onchange="populateProjectSelect()">
                                    <option value="">No Goal</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <select class="form-select" id="project-select">
                                    <option value="">No Project</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <input type="text" class="form-control" id="task-title" placeholder="Task Title" required>
                            </div>
                            <div class="mb-2">
                                <textarea class="form-control" id="task-description" placeholder="Description" rows="2"></textarea>
                            </div>
                            <div class="mb-2">
                                <select class="form-select" id="task-type" onchange="toggleRecurrenceOptions()" required>
                                    <option value="one-time">One-Time</option>
                                    <option value="recurring">Recurring</option>
                                </select>
                            </div>
                            <div class="mb-2" id="recurrence-options" style="display:none;">
                                <select class="form-select" id="recurrence-frequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <select class="form-select" id="task-priority" required>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <input type="date" class="form-control" id="task-due-date" required>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary me-2">Add Task</button>
                                <button type="button" class="btn btn-secondary" onclick="hideTaskModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Standalone Task Modal -->
        <div id="standaloneTaskModal" class="modal" style="display:none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background: #4a90e2; color: white;">
                        <h5 class="modal-title">Add Standalone Task</h5>
                        <button type="button" class="btn-close" style="filter: invert(1);" onclick="hideStandaloneTaskModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="standalone-task-form" onsubmit="event.preventDefault(); addStandaloneTask();">
                            <div class="mb-2">
                                <input type="text" class="form-control" id="standalone-task-title" placeholder="Task Title" required>
                            </div>
                            <div class="mb-2">
                                <textarea class="form-control" id="standalone-task-description" placeholder="Description" rows="2"></textarea>
                            </div>
                            <div class="mb-2">
                                <select class="form-select" id="standalone-task-type" onchange="toggleStandaloneRecurrenceOptions()" required>
                                    <option value="one-time">One-Time</option>
                                    <option value="recurring">Recurring</option>
                                </select>
                            </div>
                            <div class="mb-2" id="standalone-recurrence-options" style="display:none;">
                                <select class="form-select" id="standalone-recurrence-frequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <select class="form-select" id="standalone-task-priority" required>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <input type="date" class="form-control" id="standalone-task-due-date" required>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary me-2">Add Task</button>
                                <button type="button" class="btn btn-secondary" onclick="hideStandaloneTaskModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Goal Modal -->
        <div id="goalModal" class="modal" style="display:none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background: #4a90e2; color: white;">
                        <h5 class="modal-title">Add New Goal</h5>
                        <button type="button" class="btn-close" style="filter: invert(1);" onclick="hideGoalModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="goal-form" onsubmit="event.preventDefault(); addGoal();">
                            <div class="mb-2">
                                <input type="text" class="form-control" id="goal-title" placeholder="Goal Title" required>
                            </div>
                            <div class="mb-2">
                                <textarea class="form-control" id="goal-description" placeholder="Goal Description" rows="2"></textarea>
                            </div>
                            <div class="mb-2">
                                <input type="date" class="form-control" id="goal-target-date">
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary me-2">Add Goal</button>
                                <button type="button" class="btn btn-secondary" onclick="hideGoalModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Modal -->
        <div id="projectModal" class="modal" style="display:none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background: #4a90e2; color: white;">
                        <h5 class="modal-title">Add New Project</h5>
                        <button type="button" class="btn-close" style="filter: invert(1);" onclick="hideProjectModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="project-form" onsubmit="event.preventDefault(); addProject();">
                            <div class="mb-2">
                                <select class="form-select" id="project-goal-select">
                                    <option value="">No Goal</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <input type="text" class="form-control" id="project-title" placeholder="Project Title" required>
                            </div>
                            <div class="mb-2">
                                <textarea class="form-control" id="project-description" placeholder="Project Description" rows="2"></textarea>
                            </div>
                            <div class="mb-2">
                                <input type="date" class="form-control" id="project-target-date">
                            </div>
                            <div class="mb-2">
                                <input type="number" class="form-control" id="project-progress" min="0" max="100" placeholder="Initial Progress (0-100)">
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary me-2">Add Project</button>
                                <button type="button" class="btn btn-secondary" onclick="hideProjectModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal" style="display:none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background: #4a90e2; color: white;">
                        <h5 class="modal-title" id="editModalTitle">Edit Item</h5>
                        <button type="button" class="btn-close" style="filter: invert(1);" onclick="hideEditModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-form" onsubmit="event.preventDefault(); saveEdit();">
                            <div class="mb-2">
                                <input type="text" class="form-control" id="edit-title" placeholder="Title" required>
                            </div>
                            <div class="mb-2" id="edit-date-field">
                                <input type="date" class="form-control" id="edit-target-date">
                            </div>
                            <div class="mb-2" id="edit-progress-field" style="display:none;">
                                <input type="number" class="form-control" id="edit-progress" min="0" max="100" placeholder="Progress (0-100)">
                            </div>
                            <div class="mb-2" id="edit-priority-field" style="display:none;">
                                <select class="form-select" id="edit-priority">
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="mb-2" id="edit-type-field" style="display:none;">
                                <select class="form-select" id="edit-type">
                                    <option value="one-time">One-Time</option>
                                    <option value="recurring">Recurring</option>
                                </select>
                            </div>
                            <div class="mb-2" id="edit-recurrence-field" style="display:none;">
                                <select class="form-select" id="edit-recurrence-frequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="mb-2" id="edit-description-field">
                                <textarea class="form-control" id="edit-description" placeholder="Description" rows="2"></textarea>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary me-2">Save Changes</button>
                                <button type="button" class="btn btn-secondary" onclick="hideEditModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let data = JSON.parse(localStorage.getItem('taskData')) || { goals: [], archived: [], standaloneTasks: [] };
        let currentMonth = new Date('2025-07-21T17:32:00Z');

        function initializeApp() {
            try {
                updateDashboard();
                renderHierarchical();
                renderCalendar();
                renderList();
                populateGoalSelect();
                document.getElementById('task-type').onchange = toggleRecurrenceOptions;
                document.getElementById('standalone-task-type').onchange = toggleStandaloneRecurrenceOptions;
                document.getElementById('task-form').onsubmit = addTask;
                document.getElementById('standalone-task-form').onsubmit = addStandaloneTask;
                document.getElementById('goal-form').onsubmit = addGoal;
                document.getElementById('project-form').onsubmit = addProject;
                document.getElementById('edit-form').onsubmit = saveEdit;
                checkDueDates();
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js').catch(err => console.error('Service Worker registration failed:', err));
                }
                document.querySelectorAll('#calendar-table td').forEach(cell => {
                    cell.addEventListener('click', function() {
                        const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), parseInt(this.textContent));
                        alert(`Tasks on ${date.toDateString()}: ${getTasksForDate(date).join(', ')}`);
                    });
                });
            } catch (e) {
                console.error('Initialization error:', e);
                alert('An error occurred during initialization. Check console for details.');
            }
        }

        function updateDashboard() {
            try {
                const totalGoals = data.goals.length;
                const totalProjects = data.goals.reduce((sum, goal) => sum + goal.projects.length, 0);
                const upcomingItems = data.goals.reduce((sum, goal) => sum + goal.projects.reduce((pSum, project) => pSum + (new Date(project.targetDate || '9999-12-31') <= new Date('2025-07-21T17:32:00Z').getTime() + 7 * 24 * 60 * 60 * 1000 ? 1 : 0) + project.tasks.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    const today = new Date('2025-07-21T17:32:00Z');
                    today.setHours(0, 0, 0, 0);
                    dueDate.setHours(0, 0, 0, 0);
                    return dueDate <= new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000) && !task.archived;
                }).length, 0) + (new Date(goal.targetDate || '9999-12-31') <= new Date('2025-07-21T17:32:00Z').getTime() + 7 * 24 * 60 * 60 * 1000 ? 1 : 0), 0) +
                    data.standaloneTasks.filter(task => {
                        const dueDate = new Date(task.dueDate);
                        const today = new Date('2025-07-21T17:32:00Z');
                        today.setHours(0, 0, 0, 0);
                        dueDate.setHours(0, 0, 0, 0);
                        return dueDate <= new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000) && !task.archived;
                    }).length;

                document.getElementById('total-goals').textContent = totalGoals;
                document.getElementById('total-projects').textContent = totalProjects;
                document.getElementById('upcoming-items').textContent = upcomingItems;
            } catch (e) {
                console.error('Dashboard update error:', e);
            }
        }

        function renderHierarchical() {
            try {
                const content = document.getElementById('hierarchical-content');
                content.innerHTML = '';
                data.goals.forEach((goal, goalIndex) => {
                    const goalDiv = document.createElement('div');
                    goalDiv.className = 'goal-card';
                    goalDiv.innerHTML = `<div class="collapsible" onclick="toggleContent(this)"><h6 style="margin: 0;">${goal.title} (Target: ${goal.targetDate || 'N/A'}) <span class="small">${goal.description || 'No description'}</span> <span>▼</span></h6><button class="btn btn-warning btn-sm float-end me-2" onclick="editGoal(${goalIndex}); event.stopPropagation();">Edit</button><button class="btn btn-danger btn-sm float-end" onclick="deleteGoal(${goalIndex}); event.stopPropagation();">Delete</button></div>`;
                    const projectsDiv = document.createElement('div');
                    projectsDiv.className = 'content';
                    goal.projects.forEach((project, projectIndex) => {
                        const projectDiv = document.createElement('div');
                        projectDiv.className = 'project-card';
                        projectDiv.innerHTML = `<div class="collapsible" onclick="toggleContent(this)"><h6 style="margin: 0;">${project.title} (Target: ${project.targetDate || 'N/A'}, Progress: ${project.progress || 0}%) <span class="small">${project.description || 'No description'}</span> <span>▼</span></h6><button class="btn btn-warning btn-sm float-end me-2" onclick="editProject(${goalIndex}, ${projectIndex}); event.stopPropagation();">Edit</button><button class="btn btn-danger btn-sm float-end me-2" onclick="deleteProject(${goalIndex}, ${projectIndex}); event.stopPropagation();">Delete</button></div>`;
                        const tasksUl = document.createElement('ul');
                        tasksUl.className = 'content list-group list-group-flush';
                        project.tasks.forEach((task, taskIndex) => {
                            if (!task.archived) {
                                const taskLi = document.createElement('li');
                                taskLi.className = `task-item list-group-item ${task.type} ${task.completed ? 'completed' : ''} priority-${task.priority}`;
                                taskLi.innerHTML = `
                                    ${task.title} (${task.type === 'recurring' ? 'Recurring' : 'One-Time'}) (Due: ${task.dueDate}, Priority: ${task.priority})
                                    <br><span class="small">Status: ${task.completed ? 'Completed' : 'Pending'}</span>
                                    <button class="btn btn-sm btn-success ms-2" onclick="toggleTask(${goalIndex}, ${projectIndex}, ${taskIndex}); event.stopPropagation();">Toggle</button>
                                    <button class="btn btn-sm btn-warning ms-2" onclick="editTask(${goalIndex}, ${projectIndex}, ${taskIndex}); event.stopPropagation();">Edit</button>
                                    <button class="btn btn-sm btn-danger ms-2" onclick="deleteTask(${goalIndex}, ${projectIndex}, ${taskIndex}); event.stopPropagation();">Delete</button>
                                    <button class="btn btn-sm btn-warning ms-2" onclick="archiveTask(${goalIndex}, ${projectIndex}, ${taskIndex}); event.stopPropagation();">Archive</button>
                                `;
                                tasksUl.appendChild(taskLi);
                            }
                        });
                        projectDiv.appendChild(tasksUl);
                        projectsDiv.appendChild(projectDiv);
                    });
                    goalDiv.appendChild(projectsDiv);
                    content.appendChild(goalDiv);
                    const addProjectBtn = document.createElement('button');
                    addProjectBtn.className = 'btn btn-success ms-3 mb-2';
                    addProjectBtn.textContent = 'Add Project';
                    addProjectBtn.onclick = () => showProjectModal(goalIndex);
                    content.appendChild(addProjectBtn);
                });
            } catch (e) {
                console.error('Hierarchical render error:', e);
            }
        }

        function toggleContent(element) {
            const content = element.nextElementSibling;
            if (content) content.classList.toggle('show');
        }

        function renderCalendar() {
            try {
                const tbody = document.getElementById('calendar-body');
                tbody.innerHTML = '';
                const firstDay = new Date(currentMonth.getTime());
                firstDay.setDate(1);
                const lastDay = new Date(firstDay.getTime());
                lastDay.setMonth(lastDay.getMonth() + 1);
                lastDay.setDate(0);
                const startDay = new Date(firstDay.getTime());
                startDay.setDate(1 - firstDay.getDay() + (firstDay.getDay() === 0 ? -6 : 1));
                for (let i = 0; i < Math.ceil((lastDay.getDate() + (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1)) / 7); i++) {
                    const row = document.createElement('tr');
                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('td');
                        const date = new Date(startDay.getTime() + (i * 7 + j) * 24 * 60 * 60 * 1000);
                        if (date.getMonth() === firstDay.getMonth()) {
                            cell.textContent = date.getDate();
                            if (date.toDateString() === new Date('2025-07-21T17:32:00Z').toDateString()) cell.style.background = '#ffeb3b';
                            const items = [
                                ...data.goals.filter(goal => new Date(goal.targetDate || '9999-12-31').toDateString() === date.toDateString()),
                                ...data.goals.reduce((all, goal) => all.concat(goal.projects.filter(project => new Date(project.targetDate || '9999-12-31').toDateString() === date.toDateString())), []),
                                ...data.goals.reduce((all, goal) => all.concat(goal.projects.reduce((pAll, project) => pAll.concat(project.tasks.filter(task => new Date(task.dueDate).toDateString() === date.toDateString() && !task.archived)), [])), []),
                                ...data.standaloneTasks.filter(task => new Date(task.dueDate).toDateString() === date.toDateString() && !task.archived)
                            ];
                            if (items.length) {
                                cell.className = 'bg-light';
                                items.forEach(item => {
                                    const itemSpan = document.createElement('div');
                                    if (item.type) {
                                        itemSpan.className = `${item.type} ${item.completed ? 'completed' : ''} priority-${item.priority || 'medium'}`;
                                        itemSpan.textContent = `${item.title} (${item.type})`;
                                    } else if (item.targetDate) {
                                        itemSpan.textContent = `${item.title || item.name} (Target)`;
                                    }
                                    cell.appendChild(itemSpan);
                                });
                            }
                        }
                        row.appendChild(cell);
                    }
                    tbody.appendChild(row);
                }
            } catch (e) {
                console.error('Calendar render error:', e);
            }
        }

        function renderList(filter = 'all') {
            try {
                const content = document.getElementById('list-content');
                content.innerHTML = '';
                data.goals.forEach((goal, goalIndex) => {
                    goal.projects.forEach((project, projectIndex) => {
                        project.tasks.forEach((task, taskIndex) => {
                            if (!task.archived && (filter === 'all' || task.type === filter)) {
                                const taskLi = document.createElement('li');
                                taskLi.className = `list-group-item ${task.type} ${task.completed ? 'completed' : ''} priority-${task.priority}`;
                                taskLi.innerHTML = `
                                    ${task.title} (Goal: ${goal.title}, Project: ${project.title})
                                    <br>Due: ${task.dueDate} | Priority: ${task.priority} | Status: ${task.completed ? 'Completed' : 'Pending'}
                                    <button class="btn btn-sm btn-success ms-2" onclick="toggleTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Toggle</button>
                                    <button class="btn btn-sm btn-warning ms-2" onclick="editTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Edit</button>
                                    <button class="btn btn-sm btn-danger ms-2" onclick="deleteTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Delete</button>
                                    <button class="btn btn-sm btn-warning ms-2" onclick="archiveTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Archive</button>
                                `;
                                content.appendChild(taskLi);
                            }
                        });
                    });
                });
                data.standaloneTasks.forEach((task, taskIndex) => {
                    if (!task.archived && (filter === 'all' || task.type === filter)) {
                        const taskLi = document.createElement('li');
                        taskLi.className = `list-group-item ${task.type} ${task.completed ? 'completed' : ''} priority-${task.priority}`;
                        taskLi.innerHTML = `
                            ${task.title} (Standalone)
                            <br>Due: ${task.dueDate} | Priority: ${task.priority} | Status: ${task.completed ? 'Completed' : 'Pending'}
                            <button class="btn btn-sm btn-success ms-2" onclick="toggleStandaloneTask(${taskIndex})">Toggle</button>
                            <button class="btn btn-sm btn-warning ms-2" onclick="editStandaloneTask(${taskIndex})">Edit</button>
                            <button class="btn btn-sm btn-danger ms-2" onclick="deleteStandaloneTask(${taskIndex})">Delete</button>
                            <button class="btn btn-sm btn-warning ms-2" onclick="archiveStandaloneTask(${taskIndex})">Archive</button>
                        `;
                        content.appendChild(taskLi);
                    }
                });
            } catch (e) {
                console.error('List render error:', e);
            }
        }

        function addGoal() {
            try {
                const title = document.getElementById('goal-title').value;
                const description = document.getElementById('goal-description').value || '';
                const targetDate = document.getElementById('goal-target-date').value || null;
                if (title) {
                    data.goals.push({ title, description, targetDate, projects: [] });
                    saveData();
                    document.getElementById('goal-form').reset();
                    hideGoalModal();
                    renderHierarchical();
                    updateDashboard();
                    populateGoalSelect();
                    populateProjectGoalSelect();
                } else {
                    alert('Please enter a title.');
                }
            } catch (e) {
                console.error('Add goal error:', e);
            }
        }

        function addProject(goalIndex = null) {
            try {
                const title = document.getElementById('project-title').value;
                const description = document.getElementById('project-description').value || '';
                const targetDate = document.getElementById('project-target-date').value || null;
                const progress = parseInt(document.getElementById('project-progress').value) || 0;
                const goalSelect = document.getElementById('project-goal-select').value;
                if (title) {
                    if (goalSelect !== '' && goalIndex === null) {
                        goalIndex = goalSelect;
                    }
                    if (goalIndex !== null) {
                        data.goals[goalIndex].projects.push({ title, description, targetDate, tasks: [], progress });
                    } else {
                        data.goals.push({ title: 'Unnamed Goal', targetDate: null, description: '', projects: [{ title, description, targetDate, tasks: [], progress }] });
                    }
                    saveData();
                    document.getElementById('project-form').reset();
                    hideProjectModal();
                    renderHierarchical();
                    updateDashboard();
                    populateGoalSelect();
                    populateProjectGoalSelect();
                } else {
                    alert('Please enter a title.');
                }
            } catch (e) {
                console.error('Add project error:', e);
            }
        }

        function addTask() {
            try {
                const goalIndex = document.getElementById('goal-select').value || null;
                const projectIndex = document.getElementById('project-select').value || null;
                const title = document.getElementById('task-title').value;
                const description = document.getElementById('task-description').value;
                const type = document.getElementById('task-type').value;
                const priority = document.getElementById('task-priority').value;
                const dueDate = document.getElementById('task-due-date').value;
                if (title && dueDate) {
                    if (goalIndex !== null && projectIndex !== null) {
                        const tasksArray = data.goals[goalIndex].projects[projectIndex].tasks;
                        tasksArray.push({ title, description, type, priority, dueDate, completed: false, archived: false });
                        if (type === 'recurring') {
                            const frequency = document.getElementById('recurrence-frequency').value;
                            let interval = frequency === 'daily' ? 1 : frequency === 'weekly' ? 7 : 30;
                            interval *= 24 * 60 * 60 * 1000;
                            const nextDate = new Date(new Date(dueDate).getTime() + interval).toISOString().split('T')[0];
                            tasksArray.push({ title, description, type, priority, dueDate: nextDate, completed: false, archived: false });
                        }
                    } else {
                        alert('Please select a Goal and Project or use Add Standalone Task for independent tasks.');
                        return;
                    }
                    saveData();
                    document.getElementById('task-form').reset();
                    hideTaskModal();
                    renderHierarchical();
                    renderCalendar();
                    renderList();
                    updateDashboard();
                } else {
                    alert('Please fill all required fields.');
                }
            } catch (e) {
                console.error('Add task error:', e);
            }
        }

        function addStandaloneTask() {
            try {
                const title = document.getElementById('standalone-task-title').value;
                const description = document.getElementById('standalone-task-description').value;
                const type = document.getElementById('standalone-task-type').value;
                const priority = document.getElementById('standalone-task-priority').value;
                const dueDate = document.getElementById('standalone-task-due-date').value;
                if (title && dueDate) {
                    data.standaloneTasks.push({ title, description, type, priority, dueDate, completed: false, archived: false });
                    if (type === 'recurring') {
                        const frequency = document.getElementById('standalone-recurrence-frequency').value;
                        let interval = frequency === 'daily' ? 1 : frequency === 'weekly' ? 7 : 30;
                        interval *= 24 * 60 * 60 * 1000;
                        const nextDate = new Date(new Date(dueDate).getTime() + interval).toISOString().split('T')[0];
                        data.standaloneTasks.push({ title, description, type, priority, dueDate: nextDate, completed: false, archived: false });
                    }
                    saveData();
                    document.getElementById('standalone-task-form').reset();
                    hideStandaloneTaskModal();
                    renderCalendar();
                    renderList();
                    updateDashboard();
                } else {
                    alert('Please fill all required fields.');
                }
            } catch (e) {
                console.error('Add standalone task error:', e);
            }
        }

        function toggleTask(goalIndex, projectIndex, taskIndex) {
            try {
                data.goals[goalIndex].projects[projectIndex].tasks[taskIndex].completed = !data.goals[goalIndex].projects[projectIndex].tasks[taskIndex].completed;
                saveData();
                renderHierarchical();
                renderList();
                renderCalendar();
            } catch (e) {
                console.error('Toggle task error:', e);
            }
        }

        function toggleStandaloneTask(taskIndex) {
            try {
                data.standaloneTasks[taskIndex].completed = !data.standaloneTasks[taskIndex].completed;
                saveData();
                renderList();
                renderCalendar();
            } catch (e) {
                console.error('Toggle standalone task error:', e);
            }
        }

        function deleteGoal(goalIndex) {
            try {
                if (confirm('Delete this goal and all its projects/tasks?')) {
                    data.goals.splice(goalIndex, 1);
                    saveData();
                    renderHierarchical();
                    updateDashboard();
                    populateGoalSelect();
                    populateProjectGoalSelect();
                }
            } catch (e) {
                console.error('Delete goal error:', e);
            }
        }

        function deleteProject(goalIndex, projectIndex) {
            try {
                if (confirm('Delete this project and all its tasks?')) {
                    data.goals[goalIndex].projects.splice(projectIndex, 1);
                    saveData();
                    renderHierarchical();
                    updateDashboard();
                    populateProjectGoalSelect();
                }
            } catch (e) {
                console.error('Delete project error:', e);
            }
        }

        function deleteTask(goalIndex, projectIndex, taskIndex) {
            try {
                if (confirm('Delete this task?')) {
                    data.goals[goalIndex].projects[projectIndex].tasks.splice(taskIndex, 1);
                    saveData();
                    renderHierarchical();
                    renderList();
                    renderCalendar();
                }
            } catch (e) {
                console.error('Delete task error:', e);
            }
        }

        function deleteStandaloneTask(taskIndex) {
            try {
                if (confirm('Delete this standalone task?')) {
                    data.standaloneTasks.splice(taskIndex, 1);
                    saveData();
                    renderList();
                    renderCalendar();
                }
            } catch (e) {
                console.error('Delete standalone task error:', e);
            }
        }

        function archiveTask(goalIndex, projectIndex, taskIndex) {
            try {
                data.goals[goalIndex].projects[projectIndex].tasks[taskIndex].archived = true;
                data.archived.push(data.goals[goalIndex].projects[projectIndex].tasks[taskIndex]);
                data.goals[goalIndex].projects[projectIndex].tasks.splice(taskIndex, 1);
                saveData();
                renderHierarchical();
                renderList();
                renderCalendar();
            } catch (e) {
                console.error('Archive task error:', e);
            }
        }

        function archiveStandaloneTask(taskIndex) {
            try {
                data.standaloneTasks[taskIndex].archived = true;
                data.archived.push(data.standaloneTasks[taskIndex]);
                data.standaloneTasks.splice(taskIndex, 1);
                saveData();
                renderList();
                renderCalendar();
            } catch (e) {
                console.error('Archive standalone task error:', e);
            }
        }

        function filterTasks(filter = 'all') {
            try {
                const searchTerm = document.getElementById('task-search').value.toLowerCase();
                const content = document.getElementById('list-content');
                content.innerHTML = '';
                data.goals.forEach((goal, goalIndex) => {
                    goal.projects.forEach((project, projectIndex) => {
                        project.tasks.forEach((task, taskIndex) => {
                            if (!task.archived && (filter === 'all' || task.type === filter) && 
                                (task.title.toLowerCase().includes(searchTerm) || 
                                 (task.description && task.description.toLowerCase().includes(searchTerm)))) {
                                const taskLi = document.createElement('li');
                                taskLi.className = `list-group-item ${task.type} ${task.completed ? 'completed' : ''} priority-${task.priority}`;
                                taskLi.innerHTML = `
                                    ${task.title} (Goal: ${goal.title}, Project: ${project.title})
                                    <br>Due: ${task.dueDate} | Priority: ${task.priority} | Status: ${task.completed ? 'Completed' : 'Pending'}
                                    <button class="btn btn-sm btn-success ms-2" onclick="toggleTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Toggle</button>
                                    <button class="btn btn-sm btn-warning ms-2" onclick="editTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Edit</button>
                                    <button class="btn btn-sm btn-danger ms-2" onclick="deleteTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Delete</button>
                                    <button class="btn btn-sm btn-warning ms-2" onclick="archiveTask(${goalIndex}, ${projectIndex}, ${taskIndex})">Archive</button>
                                `;
                                content.appendChild(taskLi);
                            }
                        });
                    });
                });
                data.standaloneTasks.forEach((task, taskIndex) => {
                    if (!task.archived && (filter === 'all' || task.type === filter) && 
                        (task.title.toLowerCase().includes(searchTerm) || 
                         (task.description && task.description.toLowerCase().includes(searchTerm)))) {
                        const taskLi = document.createElement('li');
                        taskLi.className = `list-group-item ${task.type} ${task.completed ? 'completed' : ''} priority-${task.priority}`;
                        taskLi.innerHTML = `
                            ${task.title} (Standalone)
                            <br>Due: ${task.dueDate} | Priority: ${task.priority} | Status: ${task.completed ? 'Completed' : 'Pending'}
                            <button class="btn btn-sm btn-success ms-2" onclick="toggleStandaloneTask(${taskIndex})">Toggle</button>
                            <button class="btn btn-sm btn-warning ms-2" onclick="editStandaloneTask(${taskIndex})">Edit</button>
                            <button class="btn btn-sm btn-danger ms-2" onclick="deleteStandaloneTask(${taskIndex})">Delete</button>
                            <button class="btn btn-sm btn-warning ms-2" onclick="archiveStandaloneTask(${taskIndex})">Archive</button>
                        `;
                        content.appendChild(taskLi);
                    }
                });
            } catch (e) {
                console.error('Filter tasks error:', e);
            }
        }

        function populateGoalSelect() {
            try {
                const goalSelect = document.getElementById('goal-select');
                goalSelect.innerHTML = '<option value="">No Goal</option>';
                data.goals.forEach((goal, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = goal.title;
                    goalSelect.appendChild(option);
                });
            } catch (e) {
                console.error('Populate goal select error:', e);
            }
        }

        function populateProjectSelect() {
            try {
                const projectSelect = document.getElementById('project-select');
                projectSelect.innerHTML = '<option value="">No Project</option>';
                const goalIndex = document.getElementById('goal-select').value;
                if (goalIndex !== '') {
                    data.goals[goalIndex].projects.forEach((project, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = project.title;
                        projectSelect.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Populate project select error:', e);
            }
        }

        function populateProjectGoalSelect() {
            try {
                const goalSelect = document.getElementById('project-goal-select');
                goalSelect.innerHTML = '<option value="">No Goal</option>';
                data.goals.forEach((goal, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = goal.title;
                    goalSelect.appendChild(option);
                });
            } catch (e) {
                console.error('Populate project goal select error:', e);
            }
        }

        function showTaskModal() {
            try {
                populateGoalSelect();
                document.getElementById('taskModal').style.display = 'block';
                toggleRecurrenceOptions();
            } catch (e) {
                console.error('Show task modal error:', e);
            }
        }

        function hideTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('task-form').reset();
        }

        function showStandaloneTaskModal() {
            try {
                document.getElementById('standaloneTaskModal').style.display = 'block';
                toggleStandaloneRecurrenceOptions();
            } catch (e) {
                console.error('Show standalone task modal error:', e);
            }
        }

        function hideStandaloneTaskModal() {
            document.getElementById('standaloneTaskModal').style.display = 'none';
            document.getElementById('standalone-task-form').reset();
        }

        function showGoalModal() {
            try {
                document.getElementById('goalModal').style.display = 'block';
                document.getElementById('goal-form').reset();
            } catch (e) {
                console.error('Show goal modal error:', e);
            }
        }

        function hideGoalModal() {
            document.getElementById('goalModal').style.display = 'none';
        }

        function showProjectModal(goalIndex = null) {
            try {
                populateProjectGoalSelect();
                if (goalIndex !== null) {
                    document.getElementById('project-goal-select').value = goalIndex;
                }
                document.getElementById('projectModal').style.display = 'block';
                document.getElementById('project-form').reset();
            } catch (e) {
                console.error('Show project modal error:', e);
            }
        }

        function hideProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        function toggleRecurrenceOptions() {
            const type = document.getElementById('task-type').value;
            document.getElementById('recurrence-options').style.display = type === 'recurring' ? 'block' : 'none';
        }

        function toggleStandaloneRecurrenceOptions() {
            const type = document.getElementById('standalone-task-type').value;
            document.getElementById('standalone-recurrence-options').style.display = type === 'recurring' ? 'block' : 'none';
        }

        function exportData() {
            try {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
                const downloadAnchor = document.createElement('a');
                downloadAnchor.setAttribute("href", dataStr);
                downloadAnchor.setAttribute("download", "task-data.json");
                document.body.appendChild(downloadAnchor);
                downloadAnchor.click();
                document.body.removeChild(downloadAnchor);
            } catch (e) {
                console.error('Export data error:', e);
                alert('Failed to export data. Check console.');
            }
        }

        function exportToCalendar() {
            try {
                const tasks = [...data.goals.flatMap(g => g.projects.flatMap(p => p.tasks)), ...data.standaloneTasks];
                let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\n';
                tasks.forEach(task => {
                    if (!task.archived && !task.completed) {
                        ics += `BEGIN:VEVENT\nSUMMARY:${task.title}\nDTSTART:${new Date(task.dueDate).toISOString().replace(/[:-]/g, '').split('.')[0]}Z\nDUE:${new Date(task.dueDate).toISOString().replace(/[:-]/g, '').split('.')[0]}Z\nEND:VEVENT\n`;
                    }
                });
                ics += 'END:VCALENDAR';
                const dataStr = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(ics);
                const downloadAnchor = document.createElement('a');
                downloadAnchor.setAttribute('href', dataStr);
                downloadAnchor.setAttribute('download', 'tasks.ics');
                document.body.appendChild(downloadAnchor);
                downloadAnchor.click();
                document.body.removeChild(downloadAnchor);
            } catch (e) {
                console.error('Export to calendar error:', e);
                alert('Failed to export to calendar. Check console.');
            }
        }

        function importData(event) {
            try {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    data = JSON.parse(e.target.result);
                    saveData();
                    renderHierarchical();
                    renderCalendar();
                    renderList();
                    updateDashboard();
                    populateGoalSelect();
                    populateProjectGoalSelect();
                };
                reader.readAsText(file);
            } catch (e) {
                console.error('Import data error:', e);
                alert('Failed to import data. Check console.');
            }
        }

        function deleteAllData() {
            try {
                if (confirm('Are you sure you want to delete all data? This cannot be undone.')) {
                    data = { goals: [], archived: [], standaloneTasks: [] };
                    saveData();
                    renderHierarchical();
                    renderCalendar();
                    renderList();
                    updateDashboard();
                    populateGoalSelect();
                    populateProjectGoalSelect();
                }
            } catch (e) {
                console.error('Delete all data error:', e);
            }
        }

        function checkDueDates() {
            try {
                const today = new Date('2025-07-21T17:32:00Z');
                const tasks = [...data.goals.flatMap(g => g.projects.flatMap(p => p.tasks)), ...data.standaloneTasks];
                tasks.forEach(task => {
                    const dueDate = new Date(task.dueDate);
                    if (dueDate - today <= 24 * 60 * 60 * 1000 && !task.completed && !task.archived) {
                        alert(`Task due soon: ${task.title} (Due: ${task.dueDate})`);
                    }
                });
            } catch (e) {
                console.error('Check due dates error:', e);
            }
        }

        function changeMonth(delta) {
            try {
                currentMonth.setMonth(currentMonth.getMonth() + delta);
                renderCalendar();
            } catch (e) {
                console.error('Change month error:', e);
            }
        }

        function editGoal(goalIndex) {
            try {
                const goal = data.goals[goalIndex];
                document.getElementById('editModalTitle').textContent = 'Edit Goal';
                document.getElementById('edit-title').value = goal.title;
                document.getElementById('edit-description').value = goal.description || '';
                document.getElementById('edit-target-date').value = goal.targetDate || '';
                showEditModal({ type: 'goal', index: goalIndex });
            } catch (e) {
                console.error('Edit goal error:', e);
            }
        }

        function editProject(goalIndex, projectIndex) {
            try {
                const project = data.goals[goalIndex].projects[projectIndex];
                document.getElementById('editModalTitle').textContent = 'Edit Project';
                document.getElementById('edit-title').value = project.title;
                document.getElementById('edit-description').value = project.description || '';
                document.getElementById('edit-target-date').value = project.targetDate || '';
                document.getElementById('edit-progress').value = project.progress || 0;
                showEditModal({ type: 'project', goalIndex, projectIndex });
            } catch (e) {
                console.error('Edit project error:', e);
            }
        }

        function editTask(goalIndex, projectIndex, taskIndex) {
            try {
                const task = data.goals[goalIndex].projects[projectIndex].tasks[taskIndex];
                document.getElementById('editModalTitle').textContent = 'Edit Task';
                document.getElementById('edit-title').value = task.title;
                document.getElementById('edit-description').value = task.description || '';
                document.getElementById('edit-target-date').value = task.dueDate;
                document.getElementById('edit-priority').value = task.priority;
                document.getElementById('edit-type').value = task.type;
                document.getElementById('edit-recurrence-frequency').value = task.type === 'recurring' ? 'weekly' : 'daily';
                showEditModal({ type: 'task', goalIndex, projectIndex, taskIndex });
            } catch (e) {
                console.error('Edit task error:', e);
            }
        }

        function editStandaloneTask(taskIndex) {
            try {
                const task = data.standaloneTasks[taskIndex];
                document.getElementById('editModalTitle').textContent = 'Edit Standalone Task';
                document.getElementById('edit-title').value = task.title;
                document.getElementById('edit-description').value = task.description || '';
                document.getElementById('edit-target-date').value = task.dueDate;
                document.getElementById('edit-priority').value = task.priority;
                document.getElementById('edit-type').value = task.type;
                document.getElementById('edit-recurrence-frequency').value = task.type === 'recurring' ? 'weekly' : 'daily';
                showEditModal({ type: 'standaloneTask', taskIndex });
            } catch (e) {
                console.error('Edit standalone task error:', e);
            }
        }

        function showEditModal(editData) {
            try {
                document.getElementById('edit-date-field').style.display = 'block';
                document.getElementById('edit-progress-field').style.display = editData.type === 'project' ? 'block' : 'none';
                document.getElementById('edit-priority-field').style.display = ['task', 'standaloneTask'].includes(editData.type) ? 'block' : 'none';
                document.getElementById('edit-type-field').style.display = ['task', 'standaloneTask'].includes(editData.type) ? 'block' : 'none';
                document.getElementById('edit-recurrence-field').style.display = ['task', 'standaloneTask'].includes(editData.type) && document.getElementById('edit-type').value === 'recurring' ? 'block' : 'none';
                document.getElementById('edit-description-field').style.display = 'block';
                window.editData = editData;
                document.getElementById('editModal').style.display = 'block';
            } catch (e) {
                console.error('Show edit modal error:', e);
            }
        }

        function hideEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('edit-form').reset();
        }

        function saveEdit() {
            try {
                const title = document.getElementById('edit-title').value;
                const description = document.getElementById('edit-description').value || '';
                const targetDate = document.getElementById('edit-target-date').value || null;
                const progress = document.getElementById('edit-progress') ? parseInt(document.getElementById('edit-progress').value) || 0 : null;
                const priority = document.getElementById('edit-priority') ? document.getElementById('edit-priority').value : null;
                const type = document.getElementById('edit-type') ? document.getElementById('edit-type').value : null;
                const recurrenceFrequency = document.getElementById('edit-recurrence-frequency') ? document.getElementById('edit-recurrence-frequency').value : null;

                if (window.editData.type === 'goal') {
                    data.goals[window.editData.index].title = title;
                    data.goals[window.editData.index].description = description;
                    data.goals[window.editData.index].targetDate = targetDate;
                } else if (window.editData.type === 'project') {
                    data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].title = title;
                    data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].description = description;
                    data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].targetDate = targetDate;
                    if (progress !== null) data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].progress = progress;
                } else if (window.editData.type === 'task') {
                    const task = data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].tasks[window.editData.taskIndex];
                    task.title = title;
                    task.description = description;
                    task.dueDate = targetDate;
                    task.priority = priority;
                    task.type = type;
                    if (type === 'recurring' && task.type !== 'recurring') {
                        let interval = recurrenceFrequency === 'daily' ? 1 : recurrenceFrequency === 'weekly' ? 7 : 30;
                        interval *= 24 * 60 * 60 * 1000;
                        const nextDate = new Date(new Date(targetDate).getTime() + interval).toISOString().split('T')[0];
                        data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].tasks.push({ title, description, type, priority, dueDate: nextDate, completed: false, archived: false });
                    } else if (type !== 'recurring' && task.type === 'recurring') {
                        data.goals[window.editData.goalIndex].projects[window.editData.projectIndex].tasks.splice(window.editData.taskIndex + 1, 1);
                    }
                } else if (window.editData.type === 'standaloneTask') {
                    const task = data.standaloneTasks[window.editData.taskIndex];
                    task.title = title;
                    task.description = description;
                    task.dueDate = targetDate;
                    task.priority = priority;
                    task.type = type;
                    if (type === 'recurring' && task.type !== 'recurring') {
                        let interval = recurrenceFrequency === 'daily' ? 1 : recurrenceFrequency === 'weekly' ? 7 : 30;
                        interval *= 24 * 60 * 60 * 1000;
                        const nextDate = new Date(new Date(targetDate).getTime() + interval).toISOString().split('T')[0];
                        data.standaloneTasks.push({ title, description, type, priority, dueDate: nextDate, completed: false, archived: false });
                    } else if (type !== 'recurring' && task.type === 'recurring') {
                        data.standaloneTasks.splice(window.editData.taskIndex + 1, 1);
                    }
                }

                saveData();
                hideEditModal();
                renderHierarchical();
                renderCalendar();
                renderList();
                updateDashboard();
            } catch (e) {
                console.error('Save edit error:', e);
            }
        }

        function saveData() {
            try {
                localStorage.setItem('taskData', JSON.stringify(data));
            } catch (e) {
                console.error('Save data error:', e);
                alert('Storage error, clear browser data.');
            }
        }

        document.getElementById('goal-select').onchange = populateProjectSelect;

        function getTasksForDate(date) {
            try {
                return [
                    ...data.goals.flatMap(g => g.projects.flatMap(p => p.tasks.filter(t => new Date(t.dueDate).toDateString() === date.toDateString() && !t.archived))),
                    ...data.standaloneTasks.filter(t => new Date(t.dueDate).toDateString() === date.toDateString() && !t.archived)
                ].map(t => t.title);
            } catch (e) {
                console.error('Get tasks for date error:', e);
                return [];
            }
        }
    </script>
</body>
</html>
